# подготовка данных

подготавливаем данные, полученные из UCD, для использования в декомпозиции.

в таблице Unicode 15.0.0 для кодирования символа используется 21 бит, но есть нюансы:

- все определенные в таблице символы используют максимум 20 бит. все символы, которые начинаются от `U+F0000` - Private Use.
- последний кодпоинт, задействованный в декомпозиции - `U+2FA1D`, его значение кодируется 18-ю битами.
- большая часть символов кодируется 16 битами.

## в каком виде храним данные

наша задача - хранить CCC и декомпозицию (кодпоинты декомпозиции с их CCC).

### таблица данных

- разбиваем таблицу на блоки по 128 кодпоинтов (наиболее удобный размер, в результате получаем файлы с данными наименьшего размера).
- блок может быть пустым (содержать символы, не имеющие декомпозиции). так как нам незачем хранить такой блок, создаём несколько таблиц:
  - таблица индексов блоков
  - блоки данных
  - кодпоинты, декомпозиция которых не помещается в предыдущую таблицу

### запись кодпоинта

как можно увидеть из проведённых ранее тестов:

в NFD:

- в декомпозиции присутствует от 1 до 4 символов.
- основная часть - синглтоны, пары и тройки.

в NFKD:

- в декомпозиции присутствует от 1 до 18 элементов.
- основная часть - синглтоны, пары и тройки.
- по одному кодпоинту на 6, 7, 8, 18 символов в декомпозиции

возможны следующие варианты для кодпоинта:

1. стартер без декомпозиции
2. не-стартер без декомпозиции
3. синглтон (16 и 18 бит)
4. пара (16 и 18 бит)

   - стартер + стартер
   - стартер + не-стартер

5. тройка (16 и 18 бит)

   - стартер + стартер + стартер
   - стартер + стартер + не-стартер
   - стартер + не-стартер + стартер
   - стартер + не-стартер + не-стартер

6. стартер с декомпозицией в не-стартер
7. не-стартер с декомпозицией
8. декомпозиция на несколько не-стартеров
9. декомпозиция начинается со стартера, и содержит:

   - только стартеры, или не-стартер присутствует в середине декомпозиции
   - что угодно, заканчивается не-стартером (только одним)

если в декомпозиции подряд идут несколько не-стартеров, они упорядочены по CCC.

порядок байт - LE.

```
0000 0000  ____ ____    ____ ____  ____ ____    ____ ____  ____ ____    ____ ____  ____ ____ - стартер без декомпозиции
0000 0001  cccc cccc    ____ ____  ____ ____    ____ ____  ____ ____    ____ ____  ____ ____ - не стартер, только CCC
0000 0010  cycy cycy    xxxx xxxx  xxxx xxxx    yyyy yyyy  yyyy yyyy    ____ ____  ____ ____ - 16-битная пара с CCC 2го символа
0000 0011  ____ ____    ____ ____  ____ ____    xxxx xxxx  xxxx xxxx    xxxx xxxx  xxxx xxxx - синглтон (16/18 бит)
0000 0100  nnnn nnnn    iiii iiii  iiii iiii    ____ ____  ____ ____    ____ ____  ____ ____ - декомпозиция, вынесенная во внешний блок
xxxx xxxx  xxxx xxxx    yyyy yyyy  yyyy yyyy    zzzz zzzz  zzzz zzzz    cycy cycy  czcz czcz - 16-битная тройка, храним 2 ссс кода
```

тройки не пересекаются с маркерами потому, что минимально возможное первое значение декомпозиции - `0x20`.

в plain-версии стартер заменен на вынесенную в отдельный блок строку UTF-8, т.к. первый и последний символ этой декомпозиции - стартеры:

```
0000 0010  nnnn nnnn    ____ ____  ____ ____    xxxx xxxx  xxxx xxxx    xxxx xxxx  xxxx xxxx - декомпозиция записана в самом значении
0000 0110  nnnn nnnn    xxxx xxxx  xxxx xxxx    xxxx xxxx  xxxx xxxx    xxxx xxxx  xxxx xxxx - декомпозиция записана в самом значении
0000 0111  nnnn nnnn    iiii iiii  iiii iiii    ____ ____  ____ ____    ____ ____  ____ ____ - декомпозиция вынесена в plain-блок
```

во втором случае, для оптимизации чтения, длина последовательности увеличена на 2 (u64 можно представить как [u8;8], читаем [2..])
